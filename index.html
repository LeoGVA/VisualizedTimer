<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#4f46e5">

<!-- iOS用設定 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="V-Tools">

<link rel="icon" href="icon.png" type="image/png">
<link rel="apple-touch-icon" sizes="512x512" href="icon.png">
<link rel="manifest" href="manifest.json">

<title>Visual Tools</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
@keyframes flash {
  0%, 100% { background-color: #f87171; }
  50% { background-color: #ffffff; }
}
.flashing {
  animation: flash 0.5s linear infinite !important;
}
.timer-display, .sw-display {
  font-variant-numeric: tabular-nums;
  -webkit-user-select: none;
  user-select: none;
}
.progress-ring__circle {
  transform: rotate(-90deg);
  transform-origin: 50% 50%;
}
button {
  -webkit-tap-highlight-color: transparent;
}
button:active {
  transform: scale(0.95);
}
body {
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}
.tab-active {
  color: #4f46e5;
  border-bottom: 2px solid #4f46e5;
}
.content-area {
  min-height: 540px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.lap-list {
  height: 140px;
  overflow-y: auto;
}
</style>
</head>

<body class="bg-slate-50 flex flex-col items-center justify-center min-h-screen transition-colors duration-500" id="body-bg">

<div class="w-full max-w-sm p-6 bg-white rounded-[3rem] shadow-2xl text-center mx-4 relative">

  <!-- タブ -->
  <div class="flex justify-around border-b mb-6">
    <button id="tab-timer" class="pb-2 text-sm font-bold tab-active w-1/2">タイマー</button>
    <button id="tab-stopwatch" class="pb-2 text-sm font-bold text-slate-400 w-1/2">ストップウォッチ</button>
  </div>

  <div class="content-area">

    <!-- タイマー -->
    <div id="timer-content" class="space-y-6">
      <div class="relative flex items-center justify-center">
        <svg class="w-64 h-64">
          <circle class="text-slate-100" stroke-width="10" stroke="currentColor" fill="transparent" r="120" cx="128" cy="128"/>
          <circle id="progress-bar" class="text-indigo-600 progress-ring__circle"
            stroke-width="10" stroke-dasharray="753.98" stroke-dashoffset="753.98"
            stroke-linecap="round" stroke="currentColor" fill="transparent"
            r="120" cx="128" cy="128"/>
        </svg>
        <div class="absolute">
          <div class="timer-display text-5xl font-bold" id="display">00:00</div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2 px-2">
        <button onclick="addTime(60)" class="bg-slate-100 py-2 rounded-xl font-bold text-sm">+1分</button>
        <button onclick="addTime(300)" class="bg-slate-100 py-2 rounded-xl font-bold text-sm">+5分</button>
        <button onclick="addTime(10)" class="bg-slate-100 py-2 rounded-xl font-bold text-sm">+10秒</button>
      </div>

      <div class="space-y-3 px-2">
        <button id="start-btn" class="w-full bg-indigo-600 text-white font-bold py-5 rounded-2xl">START</button>
        <div class="flex space-x-3">
          <button id="stop-btn" class="flex-1 bg-slate-100 py-4 rounded-2xl">STOP</button>
          <button id="reset-btn" class="flex-1 bg-slate-100 py-4 rounded-2xl">CLEAR</button>
        </div>
      </div>
    </div>

    <!-- ストップウォッチ -->
    <div id="stopwatch-content" class="hidden space-y-6">
      <div class="text-5xl font-bold" id="sw-display">00:00.00</div>
    </div>

  </div>
</div>

<button id="stop-flash-btn" class="hidden fixed bottom-16 bg-slate-900 text-white px-10 py-4 rounded-full font-bold">
  アラームを止める
</button>

<script>
// ================= 通知許可（初回のみ） =================
function requestNotificationPermissionOnce() {
  if (!("Notification" in window)) return;
  if (Notification.permission === "default") {
    Notification.requestPermission();
  }
}
requestNotificationPermissionOnce();

// ================= タブ =================
const tabTimer = document.getElementById("tab-timer");
const tabStopwatch = document.getElementById("tab-stopwatch");
const timerContent = document.getElementById("timer-content");
const stopwatchContent = document.getElementById("stopwatch-content");

tabTimer.onclick = () => {
  tabTimer.classList.add("tab-active");
  tabStopwatch.classList.remove("tab-active");
  timerContent.classList.remove("hidden");
  stopwatchContent.classList.add("hidden");
};
tabStopwatch.onclick = () => {
  tabStopwatch.classList.add("tab-active");
  tabTimer.classList.remove("tab-active");
  stopwatchContent.classList.remove("hidden");
  timerContent.classList.add("hidden");
};

// ================= タイマー =================
let timeLeft = 0, totalTime = 0, timerInterval = null, isFlashing = false;
const display = document.getElementById("display");
const startBtn = document.getElementById("start-btn");
const stopBtn = document.getElementById("stop-btn");
const resetBtn = document.getElementById("reset-btn");
const bodyBg = document.getElementById("body-bg");
const stopFlashBtn = document.getElementById("stop-flash-btn");
const progressBar = document.getElementById("progress-bar");
const circumference = 2 * Math.PI * 120;

function updateTimerDisplay(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  display.textContent = `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

function setProgress(p, dur=0) {
  progressBar.style.transition = dur ? `stroke-dashoffset ${dur}s linear` : "none";
  progressBar.style.strokeDashoffset = circumference - circumference * p;
}

function startTimer() {
  if (timerInterval || timeLeft <= 0) return;

  startBtn.disabled = true;
  setProgress(timeLeft / totalTime, 0);
  setTimeout(() => setProgress(0, timeLeft), 50);

  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay(timeLeft);
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      triggerAlarm();
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
  startBtn.disabled = false;
}

function resetTimer() {
  stopTimer();
  stopAlarm();
  timeLeft = totalTime = 0;
  updateTimerDisplay(0);
  setProgress(0);
}

function triggerAlarm() {
  isFlashing = true;
  bodyBg.classList.add("flashing");
  stopFlashBtn.classList.remove("hidden");

  if ("Notification" in window && Notification.permission === "granted") {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification("⏱ タイマー終了", {
        body: "設定した時間になりました",
        icon: "icon.png",
        badge: "icon.png",
        tag: "timer-finished",
        renotify: true
      });
    });
  }
}

function stopAlarm() {
  isFlashing = false;
  bodyBg.classList.remove("flashing");
  stopFlashBtn.classList.add("hidden");
}

startBtn.onclick = startTimer;
stopBtn.onclick = stopTimer;
resetBtn.onclick = resetTimer;
stopFlashBtn.onclick = stopAlarm;

// ================= Service Worker =================
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
